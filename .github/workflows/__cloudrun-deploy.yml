on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      service_name:
        required: true
        type: string
      migrations:
        required: false
        type: boolean
        default: false
      seed_enabled:
        required: false
        type: boolean
        default: false
      working-directory:
        required: true
        type: string
        default: .

permissions:
  contents: read
  id-token: write

env:
  IMAGE_NAME: ${{ inputs.service_name }}
  BUN_VERSION: "1.3.2"
  NODE_VERSION: "22"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read
      id-token: write

    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ vars.REGION }}-docker.pkg.dev

      - name: Build Monorepo
        run: bun run build

      - name: Build Docker image
        working-directory: ${{ inputs.working-directory }}
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: Tag Docker image
        run: |
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker tag ${{ env.IMAGE_NAME }}:latest ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:latest

      - name: Push Docker image
        run: |
          docker push ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:latest

  migrate:
    name: Migrate
    needs: build
    if: ${{ inputs.migrations }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run database migrations
        working-directory: ${{ inputs.working-directory }}
        run: |
          DATABASE_URL=$(gcloud run services describe ${{ inputs.service_name }} \
            --region ${{ vars.REGION }} \
            --format=json | jq -r '.spec.template.spec.containers[0].env[] | select(.name=="DATABASE_URL") | .value')
          DATABASE_URL=$DATABASE_URL bun run db:push

  deploy:
    name: Deploy
    needs: [build, migrate]
    if: ${{ always() && needs.build.result == 'success' && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped') }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --region ${{ vars.REGION }}

  seed:
    name: Seed
    needs: deploy
    if: ${{ inputs.seed_enabled }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Seed database
        run: |
          JOB_NAME="${{ inputs.service_name }}-seed"

          # Get env vars from the deployed service
          SERVICE_CONFIG=$(gcloud run services describe ${{ inputs.service_name }} \
            --region ${{ vars.REGION }} \
            --format=json)

          # Extract environment variables and format for job creation
          ENV_VARS=$(echo "$SERVICE_CONFIG" | jq -r '.spec.template.spec.containers[0].env | map("\(.name)=\(.value)") | join(",")')

          # Get the service account from the deployed service
          SERVICE_ACCOUNT=$(echo "$SERVICE_CONFIG" | jq -r '.spec.template.spec.serviceAccountName')

          # Check if job exists
          if gcloud run jobs describe "$JOB_NAME" --region ${{ vars.REGION }} &>/dev/null; then
            echo "Updating existing job..."
            gcloud run jobs update "$JOB_NAME" \
              --image ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --region ${{ vars.REGION }} \
              --service-account "$SERVICE_ACCOUNT" \
              --set-env-vars "$ENV_VARS" \
              --command "bun" \
              --args "seed.js" \
              --max-retries 0 \
              --task-timeout 300s
          else
            echo "Creating new job..."
            gcloud run jobs create "$JOB_NAME" \
              --image ${{ vars.REPOSITORY_URL }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
              --region ${{ vars.REGION }} \
              --service-account "$SERVICE_ACCOUNT" \
              --set-env-vars "$ENV_VARS" \
              --command "bun" \
              --args "seed.js" \
              --max-retries 0 \
              --task-timeout 300s
          fi

          # Execute the job and wait for completion
          gcloud run jobs execute "$JOB_NAME" \
            --region ${{ vars.REGION }} \
            --wait
